{% extends 'base_tailwind.html' %}

{% block title %}Quiz - {{ quiz.title }} - SmartEtude{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 relative overflow-hidden">
    <!-- Animated Background -->
    <div class="absolute inset-0 overflow-hidden">
        <!-- Animated Particles -->
        <div class="particle" style="--delay: 0s; --x: 10%;"></div>
        <div class="particle" style="--delay: 2s; --x: 20%;"></div>
        <div class="particle" style="--delay: 4s; --x: 80%;"></div>
        <div class="particle" style="--delay: 6s; --x: 90%;"></div>
        
        <!-- Geometric Shapes -->
        <div class="absolute top-20 left-10 w-32 h-32 border border-emerald-400/20 rounded-full animate-pulse"></div>
        <div class="absolute top-40 right-20 w-24 h-24 border border-emerald-300/20 rotate-45 animate-pulse" style="animation-delay: 1s;"></div>
        <div class="absolute bottom-20 left-1/4 w-16 h-16 border border-emerald-500/20 rounded-full animate-pulse" style="animation-delay: 2s;"></div>
        
        <!-- Tech Grid -->
        <div class="absolute inset-0 opacity-5">
            <div class="grid grid-cols-12 gap-4 h-full">
                {% for i in "123456789012" %}
                <div class="border-r border-emerald-400/20"></div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="relative z-10 container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <div class="inline-flex items-center px-4 py-2 bg-emerald-500/10 border border-emerald-400/30 rounded-full text-emerald-300 text-sm font-medium mb-4">
                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                Quiz en cours
            </div>
            <h1 class="text-4xl md:text-5xl font-bold text-white mb-4">
                {{ quiz.title }}
            </h1>
            <p class="text-lg text-gray-300 max-w-2xl mx-auto">
                Testez vos connaissances avec ce quiz généré par l'IA
            </p>
        </div>

        <!-- Quiz Progress & Timer -->
        <div class="max-w-4xl mx-auto mb-8">
            <div class="bg-white/5 backdrop-blur-xl border border-white/10 rounded-2xl p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center space-x-6">
                        <div>
                            <span class="text-white font-medium">Progression</span>
                            <span class="text-emerald-400 font-bold ml-2" id="progress-text">1 / {{ questions|length }}</span>
                        </div>
                        <div>
                            <span class="text-white font-medium">Temps écoulé</span>
                            <span class="text-emerald-400 font-bold ml-2" id="timer-display">00:00</span>
                        </div>
                    </div>
                    <div class="text-right">
                        <span class="text-gray-300 text-sm">Questions restantes</span>
                        <span class="text-emerald-400 font-bold ml-2" id="remaining-questions">{{ questions|length }}</span>
                    </div>
                </div>
                <div class="w-full bg-emerald-900/50 rounded-full h-3">
                    <div class="bg-gradient-to-r from-emerald-400 to-emerald-600 h-3 rounded-full transition-all duration-500 shadow-lg" 
                         id="progress-bar" style="width: 0%;"></div>
                </div>
            </div>
        </div>

        <!-- Quiz Form -->
        <form method="post" class="max-w-4xl mx-auto">
            {% csrf_token %}
            <div class="bg-white/5 backdrop-blur-xl border border-white/10 rounded-2xl p-8">
                {% for question in questions %}
                <div class="question-block mb-8 {% if not forloop.first %}hidden{% endif %}" data-question="{{ forloop.counter }}">
                    <!-- Question Header -->
                    <div class="flex items-center mb-6">
                        <div class="flex-shrink-0 w-12 h-12 bg-gradient-to-r from-emerald-400 to-emerald-600 rounded-full flex items-center justify-center text-white font-bold text-lg mr-4">
                            {{ forloop.counter }}
                        </div>
                        <div class="flex-1">
                            <h3 class="text-xl font-semibold text-white mb-2">{{ question.question_text }}</h3>
                            <p class="text-gray-300 text-sm">Sélectionnez la meilleure réponse</p>
                        </div>
                    </div>

                    <!-- Answer Options -->
                    <div class="space-y-3">
                        {% if question.question_type == 'true_false' %}
                            <!-- Vrai/Faux Options -->
                            <label class="answer-option block cursor-pointer">
                                <input type="radio" name="question_{{ question.id }}" value="true" class="sr-only" required>
                                <div class="p-4 border border-emerald-300/30 rounded-xl transition-all duration-300 hover:border-emerald-400/60 hover:bg-emerald-500/20 group bg-white/10">
                                    <div class="flex items-center">
                                        <div class="w-5 h-5 border-2 border-emerald-300 rounded-full mr-3 transition-all duration-300 group-hover:border-emerald-400">
                                            <div class="w-full h-full rounded-full bg-emerald-400 scale-0 transition-transform duration-300 group-hover:scale-100"></div>
                                        </div>
                                        <span class="text-white font-medium group-hover:text-emerald-100 transition-colors duration-300">Vrai</span>
                                    </div>
                                </div>
                            </label>
                            
                            <label class="answer-option block cursor-pointer">
                                <input type="radio" name="question_{{ question.id }}" value="false" class="sr-only" required>
                                <div class="p-4 border border-emerald-300/30 rounded-xl transition-all duration-300 hover:border-emerald-400/60 hover:bg-emerald-500/20 group bg-white/10">
                                    <div class="flex items-center">
                                        <div class="w-5 h-5 border-2 border-emerald-300 rounded-full mr-3 transition-all duration-300 group-hover:border-emerald-400">
                                            <div class="w-full h-full rounded-full bg-emerald-400 scale-0 transition-transform duration-300 group-hover:scale-100"></div>
                                        </div>
                                        <span class="text-white font-medium group-hover:text-emerald-100 transition-colors duration-300">Faux</span>
                                    </div>
                                </div>
                            </label>
                        {% elif question.options %}
                            {% for choice in question.options %}
                            <label class="answer-option block cursor-pointer">
                                <input type="radio" name="question_{{ question.id }}" value="{{ forloop.counter0 }}" class="sr-only" required>
                                <div class="p-4 border border-emerald-300/30 rounded-xl transition-all duration-300 hover:border-emerald-400/60 hover:bg-emerald-500/20 group bg-white/10">
                                    <div class="flex items-center">
                                        <div class="w-5 h-5 border-2 border-emerald-300 rounded-full mr-3 transition-all duration-300 group-hover:border-emerald-400">
                                            <div class="w-full h-full rounded-full bg-emerald-400 scale-0 transition-transform duration-300 group-hover:scale-100"></div>
                                        </div>
                                        <span class="text-white font-medium group-hover:text-emerald-100 transition-colors duration-300">{{ choice }}</span>
                                    </div>
                                </div>
                            </label>
                            {% endfor %}
                        {% else %}
                            <div class="p-6 text-center border-2 border-dashed border-emerald-300/30 rounded-xl bg-emerald-500/5">
                                <svg class="w-12 h-12 mx-auto text-emerald-400/50 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                                </svg>
                                <p class="text-emerald-300 font-medium">Cette question n'a pas d'options</p>
                                <p class="text-emerald-400/70 text-sm mt-1">Veuillez contacter l'administrateur</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}

                <!-- Navigation Buttons -->
                <div class="flex items-center justify-between pt-8 border-t border-gray-600/30">
                    <button type="button" id="prev-btn" class="prev-btn px-6 py-3 bg-emerald-600/30 hover:bg-emerald-500/40 text-white rounded-xl transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed hidden border border-emerald-400/30">
                        <svg class="w-5 h-5 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                        </svg>
                        Précédent
                    </button>
                    
                    <div class="flex items-center space-x-4">
                        <span class="text-gray-400 text-sm">
                            Question <span id="current-question">1</span> sur {{ questions|length }}
                        </span>
                    </div>
                    
                    <button type="button" id="next-btn" class="next-btn px-6 py-3 bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 text-white rounded-xl transition-all duration-300 font-medium">
                        Suivant
                        <svg class="w-5 h-5 ml-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                    </button>
                    
                    <button type="submit" id="submit-btn" class="submit-btn px-8 py-3 bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 text-white rounded-xl transition-all duration-300 font-medium hidden">
                        Terminer le Quiz
                        <svg class="w-5 h-5 ml-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Custom CSS for Quiz Functionality -->
<style>
    .particle {
        position: absolute;
        width: 4px;
        height: 4px;
        background: linear-gradient(45deg, #10b981, #34d399);
        border-radius: 50%;
        animation: float 8s infinite;
        animation-delay: var(--delay);
        left: var(--x);
        opacity: 0.6;
    }

    @keyframes float {
        0%, 100% { transform: translateY(0px) scale(1); opacity: 0.6; }
        50% { transform: translateY(-20px) scale(1.2); opacity: 1; }
    }

    .answer-option input:checked + div {
        border-color: #10b981;
        background-color: rgba(16, 185, 129, 0.2);
    }

    .answer-option input:checked + div .w-5 {
        border-color: #10b981;
    }

    .answer-option input:checked + div .w-5 .bg-emerald-400 {
        transform: scale(1);
    }

    .question-block {
        animation: fadeIn 0.5s ease-in-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .glass-effect {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
</style>

<!-- Quiz Navigation JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const questions = document.querySelectorAll('.question-block');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const submitBtn = document.getElementById('submit-btn');
    const currentQuestionSpan = document.getElementById('current-question');
    
    let currentQuestion = 0;
    const totalQuestions = questions.length;
    
    // Timer functionality
    let startTime = Date.now();
    let timerInterval;
    
    function startTimer() {
        timerInterval = setInterval(updateTimer, 1000);
    }
    
    function updateTimer() {
        const elapsed = Date.now() - startTime;
        const minutes = Math.floor(elapsed / 60000);
        const seconds = Math.floor((elapsed % 60000) / 1000);
        document.getElementById('timer-display').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
    
    function stopTimer() {
        if (timerInterval) {
            clearInterval(timerInterval);
        }
        return Date.now() - startTime;
    }
    
    // Start timer when page loads
    startTimer();

    function showQuestion(index) {
        questions.forEach((q, i) => {
            q.classList.toggle('hidden', i !== index);
        });
        
        currentQuestionSpan.textContent = index + 1;
        
        // Update button states
        prevBtn.classList.toggle('hidden', index === 0);
        nextBtn.classList.toggle('hidden', index === totalQuestions - 1);
        submitBtn.classList.toggle('hidden', index !== totalQuestions - 1);
        
        // Update progress bar
        const progress = ((index + 1) / totalQuestions) * 100;
        document.getElementById('progress-bar').style.width = progress + '%';
        
        // Update progress text
        document.getElementById('progress-text').textContent = (index + 1) + ' / ' + totalQuestions;
        
        // Update remaining questions
        document.getElementById('remaining-questions').textContent = totalQuestions - (index + 1);
    }

    function nextQuestion() {
        if (currentQuestion < totalQuestions - 1) {
            currentQuestion++;
            showQuestion(currentQuestion);
        }
    }

    function prevQuestion() {
        if (currentQuestion > 0) {
            currentQuestion--;
            showQuestion(currentQuestion);
        }
    }

    // Event listeners
    nextBtn.addEventListener('click', nextQuestion);
    prevBtn.addEventListener('click', prevQuestion);

    // Initialize
    showQuestion(0);

    // Form validation and timer submission
    const form = document.querySelector('form');
    let timerStopped = false;
    
    form.addEventListener('submit', function(e) {
        // Vérifier si c'est la soumission finale (bouton "Terminer le Quiz")
        const submitBtn = document.getElementById('submit-btn');
        const isFinalSubmit = submitBtn && submitBtn.style.display !== 'none';
        
        console.log('DEBUG: Soumission du formulaire, isFinalSubmit:', isFinalSubmit);
        
        if (isFinalSubmit && !timerStopped) {
            // Vérifier qu'une réponse est sélectionnée pour la question actuelle
            const currentQuestionEl = questions[currentQuestion];
            const selectedAnswer = currentQuestionEl.querySelector('input:checked');
            
            if (!selectedAnswer) {
                e.preventDefault();
                alert('Veuillez sélectionner une réponse avant de terminer le quiz.');
                return false;
            }
            
            // Stop timer and add time to form seulement pour la soumission finale
            const timeElapsed = stopTimer();
            timerStopped = true;
            console.log('DEBUG: Temps écoulé (ms):', timeElapsed);
            
            // Vérifier si l'input existe déjà
            let timeInput = form.querySelector('input[name="time_elapsed"]');
            if (!timeInput) {
                timeInput = document.createElement('input');
                timeInput.type = 'hidden';
                timeInput.name = 'time_elapsed';
                form.appendChild(timeInput);
            }
            timeInput.value = timeElapsed;
            console.log('DEBUG: Input ajouté avec valeur:', timeElapsed);
        }
    });
});
</script>
{% endblock %}
