{% extends 'base_tailwind.html' %}
{% load static %}

{% block title %}Chat IA - {{ course.title }}{% endblock %}

{% block extra_css %}
<style>
/* Barre de d√©filement personnalis√©e */
.scrollbar-thin {
    scrollbar-width: auto;
    scrollbar-color: #8b5cf6 #1e1b4b;
}

.scrollbar-thin::-webkit-scrollbar {
    width: 12px;
}

.scrollbar-thin::-webkit-scrollbar-track {
    background: rgba(30, 27, 75, 0.8);
    border-radius: 6px;
    border: 1px solid rgba(139, 92, 246, 0.2);
}

.scrollbar-thin::-webkit-scrollbar-thumb {
    background: linear-gradient(45deg, #8b5cf6, #3b82f6);
    border-radius: 6px;
    border: 2px solid rgba(30, 27, 75, 0.8);
    transition: all 0.3s ease;
}

.scrollbar-thin::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(45deg, #7c3aed, #2563eb);
    border-color: rgba(30, 27, 75, 1);
    transform: scale(1.1);
}

.scrollbar-thin::-webkit-scrollbar-thumb:active {
    background: linear-gradient(45deg, #6d28d9, #1d4ed8);
}

/* Animation pour les boutons scroll */
#scroll-to-top, #scroll-to-bottom {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

#scroll-to-top:hover {
    transform: translateY(-2px) scale(1.1);
    box-shadow: 0 10px 25px rgba(34, 197, 94, 0.4);
}

#scroll-to-bottom:hover {
    transform: translateY(-2px) scale(1.1);
    box-shadow: 0 10px 25px rgba(139, 92, 246, 0.4);
}

/* Animation pour les messages */
.message-enter {
    animation: messageSlideIn 0.3s ease-out;
}

@keyframes messageSlideIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900">
    <!-- Particules anim√©es -->
    <div class="absolute inset-0 overflow-hidden">
        <div class="absolute -top-40 -right-40 w-80 h-80 bg-purple-500 rounded-full mix-blend-multiply filter blur-xl opacity-20 animate-pulse"></div>
        <div class="absolute -bottom-40 -left-40 w-80 h-80 bg-blue-500 rounded-full mix-blend-multiply filter blur-xl opacity-20 animate-pulse"></div>
    </div>

    <div class="relative z-10 container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white mb-4">
                <span class="bg-gradient-to-r from-purple-400 to-blue-400 bg-clip-text text-transparent">
                    Chat IA Intelligent
                </span>
            </h1>
            <p class="text-gray-300 text-lg">Posez vos questions sur le cours</p>
        </div>

        <!-- Chat Container -->
        <div class="max-w-4xl mx-auto">
            <div class="bg-white/10 backdrop-blur-lg rounded-2xl border border-white/20 shadow-2xl overflow-hidden">
                <!-- Chat Header -->
                <div class="bg-white/5 backdrop-blur-sm p-6 border-b border-white/10">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-xl font-semibold text-white">{{ course.title }}</h2>
                            <p class="text-gray-300 text-sm">Assistant IA sp√©cialis√© dans ce contenu</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <div class="w-3 h-3 bg-green-400 rounded-full animate-pulse"></div>
                            <span class="text-green-400 text-sm font-medium">En ligne</span>
                        </div>
                    </div>
                </div>

                <!-- Chat Messages -->
                <div id="chat-messages" class="h[calc(100vh-300px)] overflow-y-auto p-6 pb-24 space-y-4 scrollbar-thin scrollbar-thumb-purple-400 scrollbar-track-transparent hover:scrollbar-thumb-purple-300 scroll-smooth break-words whitespace-pre-wrap" style="scrollbar-width: auto; scrollbar-color: #8b5cf6 #1e1b4b;">
                    <!-- Message de bienvenue -->
                    <div class="flex items-start space-x-3">
                        <div class="w-8 h-8 bg-gradient-to-r from-green-500 to-blue-500 rounded-full flex items-center justify-center">
                            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <div class="bg-white/5 backdrop-blur-sm rounded-xl p-4 border border-white/10">
                                <p class="text-gray-100 leading-relaxed break-words whitespace-pre-wrap">
                                    üëã Bonjour ! Je suis votre assistant IA sp√©cialis√© dans le contenu de ce cours. 
                                    Posez-moi n'importe quelle question et je vous aiderai √† mieux comprendre le sujet !
                                </p>
                            </div>
                            <p class="text-gray-400 text-xs mt-2">Assistant IA ‚Ä¢ Maintenant</p>
                        </div>
                    </div>
                </div>

                <!-- Chat Input -->
                <div class="bg-white/5 backdrop-blur-sm p-4 border-t border-white/10">
                    
                    <form id="chat-form" method="post" class="flex items-end space-x-3">
                        {% csrf_token %}
                        <div class="flex-1">
                            <textarea id="question-input" name="question" 
                                      rows="1"
                                      placeholder="Posez votre question sur le cours..." 
                                      class="w-full bg-white/10 backdrop-blur-sm rounded-xl p-4 border border-white/20 text-white placeholder-gray-400 focus:border-purple-400 focus:ring-2 focus:ring-purple-400/50 transition-all duration-300 resize-none"
                                      style="min-height: 48px; max-height: 120px;"
                                      required></textarea>
                        </div>
                        <button type="submit" 
                                id="send-button"
                                class="w-10 h-10 bg-gradient-to-r from-purple-500 to-blue-500 hover:from-purple-600 hover:to-blue-600 text-white rounded-full shadow-lg hover:shadow-xl transition-all duration-300 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
                                disabled>
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                            </svg>
                        </button>
                    </form>
                    
                    <!-- Suggestions de questions -->
                    <div class="mt-4">
                        <p class="text-gray-400 text-sm mb-2">Questions sugg√©r√©es :</p>
                        <div class="flex flex-wrap gap-2">
                            <button type="button" class="suggestion-btn bg-white/5 hover:bg-white/10 text-gray-300 hover:text-white px-3 py-2 rounded-lg text-sm border border-white/20 transition-all duration-300">
                                Explique-moi le concept principal
                            </button>
                            <button type="button" class="suggestion-btn bg-white/5 hover:bg-white/10 text-gray-300 hover:text-white px-3 py-2 rounded-lg text-sm border border-white/20 transition-all duration-300">
                                Donne-moi des exemples
                            </button>
                            <button type="button" class="suggestion-btn bg-white/5 hover:bg-white/10 text-gray-300 hover:text-white px-3 py-2 rounded-lg text-sm border border-white/20 transition-all duration-300">
                                Quels sont les points importants ?
                            </button>
                            <button type="button" class="suggestion-btn bg-white/5 hover:bg-white/10 text-gray-300 hover:text-white px-3 py-2 rounded-lg text-sm border border-white/20 transition-all duration-300">
                                Comment appliquer ce concept ?
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="mt-8 flex flex-col sm:flex-row gap-4">
                <a href="{% url 'ai_summary' course_id=course.id %}" class="flex-1 bg-gradient-to-r from-green-500 to-blue-500 hover:from-green-600 hover:to-blue-600 text-white font-semibold py-4 px-8 rounded-xl transition-all duration-300 transform hover:scale-105 shadow-lg text-center">
                    <span class="flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        G√©n√©rer un R√©sum√© IA
                    </span>
                </a>
                
                <a href="{% url 'ai_quiz' course_id=course.id %}" class="flex-1 bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600 text-white font-semibold py-4 px-8 rounded-xl transition-all duration-300 transform hover:scale-105 shadow-lg text-center">
                    <span class="flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Cr√©er un Quiz IA
                    </span>
                </a>
                
                <a href="{% url 'course_detail' course_id=course.id %}" class="flex-1 bg-white/10 backdrop-blur-sm hover:bg-white/20 text-white font-semibold py-4 px-8 rounded-xl border border-white/20 transition-all duration-300 text-center">
                    Retour au Cours
                </a>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatForm = document.getElementById('chat-form');
    const chatMessages = document.getElementById('chat-messages');
    const questionInput = document.getElementById('question-input');
    const sendButton = document.getElementById('send-button');
    const suggestionBtns = document.querySelectorAll('.suggestion-btn');
    
    // Auto-resize textarea
    questionInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        
        // Enable/disable send button
        sendButton.disabled = this.value.trim() === '';
    });
    
    // Gestion de la touche Entr√©e
    questionInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            if (!sendButton.disabled) {
                chatForm.dispatchEvent(new Event('submit'));
            }
        }
    });
    
    // Fonction pour faire d√©filer vers le bas
    function scrollToBottom(smooth = true) {
        // Attendre que le DOM soit mis √† jour
        setTimeout(() => {
            if (smooth) {
                chatMessages.scrollTo({
                    top: chatMessages.scrollHeight + 100, // Marge suppl√©mentaire
                    behavior: 'smooth'
                });
            } else {
                chatMessages.scrollTop = chatMessages.scrollHeight + 100;
            }
        }, 50);
    }
    
    // D√©filement automatique initial
    scrollToBottom(false);

    // Gestion des suggestions
    suggestionBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            questionInput.value = this.textContent;
            questionInput.style.height = 'auto';
            questionInput.style.height = Math.min(questionInput.scrollHeight, 120) + 'px';
            sendButton.disabled = false;
            questionInput.focus();
        });
    });

    // Gestion du formulaire de chat
    chatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const question = questionInput.value.trim();
        if (!question) return;

        // Ajouter la question de l'utilisateur
        addMessage(question, 'user');
        
        // Afficher le loading
        addLoadingMessage();
        
        // Envoyer la requ√™te
        fetch(window.location.href, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: `question=${encodeURIComponent(question)}`
        })
        .then(response => response.json())
        .then(data => {
            // Supprimer le loading
            removeLoadingMessage();
            
            if (data.success) {
                addMessage(data.answer, 'ai');
            } else {
                addMessage('D√©sol√©, je ne peux pas r√©pondre √† votre question pour le moment.', 'ai', true);
            }
        })
        .catch(error => {
            removeLoadingMessage();
            addMessage('Une erreur est survenue. Veuillez r√©essayer.', 'ai', true);
        });

        questionInput.value = '';
        questionInput.style.height = 'auto';
        sendButton.disabled = true;
    });

    function addMessage(content, sender, isError = false) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `flex items-start space-x-3 message-enter ${sender === 'user' ? 'flex-row-reverse space-x-reverse' : ''}`;
        
        const avatar = sender === 'user' ? 
            '<div class="w-8 h-8 bg-gradient-to-r from-gray-600 to-gray-700 rounded-full flex items-center justify-center"><svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg></div>' :
            '<div class="w-8 h-8 bg-gradient-to-r from-green-500 to-blue-500 rounded-full flex items-center justify-center"><svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg></div>';

        // Styles diff√©renci√©s comme ChatGPT
        const messageClass = isError ? 
            'bg-red-500/20 backdrop-blur-sm rounded-xl p-4 border border-red-500/30' :
            sender === 'user' ? 
                'bg-gradient-to-r from-purple-500/20 to-blue-500/20 backdrop-blur-sm rounded-xl p-4 border border-purple-400/30' :
                'bg-white/5 backdrop-blur-sm rounded-xl p-4 border border-white/10';

        messageDiv.innerHTML = `
            ${avatar}
            <div class="flex-1">
                <div class="${messageClass}">
                    <p class="text-white break-words whitespace-pre-wrap">${content}</p>
                </div>
                <p class="text-gray-400 text-xs mt-1">${sender === 'user' ? 'Vous' : 'Assistant IA'} ‚Ä¢ Maintenant</p>
            </div>
        `;
        
        chatMessages.appendChild(messageDiv);
        
        // D√©filement automatique vers le bas
        setTimeout(() => {
            scrollToBottom();
        }, 100);
    }

    function addLoadingMessage() {
        const loadingDiv = document.createElement('div');
        loadingDiv.id = 'loading-message';
        loadingDiv.className = 'flex items-start space-x-3';
        loadingDiv.innerHTML = `
            <div class="w-8 h-8 bg-gradient-to-r from-purple-500 to-blue-500 rounded-full flex items-center justify-center">
                <svg class="w-4 h-4 text-white animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
            </div>
            <div class="flex-1">
                <div class="bg-white/10 backdrop-blur-sm rounded-xl p-4 border border-white/20">
                    <div class="flex items-center space-x-2">
                        <div class="w-2 h-2 bg-purple-400 rounded-full animate-bounce"></div>
                        <div class="w-2 h-2 bg-purple-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                        <div class="w-2 h-2 bg-purple-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                        <span class="text-gray-300 ml-2">L'IA r√©fl√©chit...</span>
                    </div>
                </div>
            </div>
        `;
        
        chatMessages.appendChild(loadingDiv);
        
        // D√©filement automatique vers le bas
        setTimeout(() => {
            scrollToBottom();
        }, 100);
    }

    function removeLoadingMessage() {
        const loadingMessage = document.getElementById('loading-message');
        if (loadingMessage) {
            loadingMessage.remove();
        }
    }
});
</script>
{% endblock %}
